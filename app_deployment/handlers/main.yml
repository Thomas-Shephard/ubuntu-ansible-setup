---
# handlers file for app_deployment
- name: restart webhook
  ansible.builtin.systemd:
    name: webhook
    state: restarted

- name: restart nginx
  ansible.builtin.service:
    name: nginx
    state: restarted

- name: restart apparmor
  ansible.builtin.service:
    name: apparmor
    state: restarted

- name: restore apparmor restriction
  ansible.builtin.sysctl:
    name: kernel.apparmor_restrict_unprivileged_userns
    value: '1'
    state: present
  become: yes

- name: restart app service
  ansible.builtin.systemd:
    name: app.service
    scope: user
    state: restarted
    daemon_reload: yes
  become: yes
  become_user: "{{ app_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ app_user_uid.stdout }}"