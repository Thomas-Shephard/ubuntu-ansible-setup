---
- name: Create Nginx site configuration
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: "/etc/nginx/sites-available/{{ app_domain_name }}"
  notify: restart nginx

- name: Create internal Nginx site configuration
  ansible.builtin.template:
    src: nginx_internal.conf.j2
    dest: "/etc/nginx/sites-available/{{ app_domain_name }}.internal"
  notify: restart nginx
  become: yes

- name: Enable Nginx site
  ansible.builtin.file:
    src: "/etc/nginx/sites-available/{{ app_domain_name }}"
    dest: "/etc/nginx/sites-enabled/{{ app_domain_name }}"
    state: link
  notify: restart nginx

- name: Enable internal Nginx site
  ansible.builtin.file:
    src: "/etc/nginx/sites-available/{{ app_domain_name }}.internal"
    dest: "/etc/nginx/sites-enabled/{{ app_domain_name }}.internal"
    state: link
  notify: restart nginx
  become: yes

- name: Ensure Nginx is running (flush handlers)
  ansible.builtin.meta: flush_handlers

- name: Install Certbot
  ansible.builtin.apt:
    name:
      - certbot
      - python3-certbot-nginx
    state: present
    update_cache: yes
    cache_valid_time: 3600
  become: yes

- name: Verify DNS resolution for required domains
  ansible.builtin.command:
    cmd: "dig +short A {{ item }}"
  loop:
    - "{{ app_domain_name }}"
    - "webhook.{{ app_domain_name }}"
  register: dig_results
  changed_when: false

- name: Fail if DNS does not resolve to this host
  ansible.builtin.fail:
    msg: "DNS for {{ item.item }} resolves to {{ item.stdout | trim }}, but expected {{ ansible_host }}. Please update your DNS records."
  loop: "{{ dig_results.results }}"
  when: item.stdout | trim != ansible_host

- name: Request Let's Encrypt Certificate
  ansible.builtin.command:
    cmd: >
      certbot certonly --nginx
      -d {{ app_domain_name }}
      -d webhook.{{ app_domain_name }}
      --non-interactive
      --agree-tos
      --email {{ certbot_email }}
  register: certbot_request
  changed_when: "'Congratulations' in certbot_request.stdout"
  failed_when:
    - certbot_request.rc != 0
    - "'Certificate not yet due for renewal' not in certbot_request.stdout"
  become: yes

- name: Configure Nginx for HTTPS
  ansible.builtin.template:
    src: nginx_https.conf.j2
    dest: "/etc/nginx/sites-available/{{ app_domain_name }}"
  notify: restart nginx
  become: yes
