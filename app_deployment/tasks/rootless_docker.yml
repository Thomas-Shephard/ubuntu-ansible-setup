---
# tasks file for rootless_docker setup for app_user
- name: Get app_user uid
  ansible.builtin.command:
    cmd: "id -u {{ app_user }}"
  register: app_user_uid
  changed_when: false

- name: Check if rootless Docker is already installed
  ansible.builtin.stat:
    path: "/home/{{ app_user }}/.config/systemd/user/docker.service"
  register: docker_service_file
  become: yes
  become_user: "{{ app_user }}"

- name: Install and configure rootless Docker
  when: not docker_service_file.stat.exists
  block:
    - name: Check if linger file exists for app_user
      ansible.builtin.stat:
        path: "/var/lib/systemd/linger/{{ app_user }}"
      register: linger_file
      become: yes

    - name: Enable lingering for app_user
      ansible.builtin.command:
        cmd: "loginctl enable-linger {{ app_user }}"
      when: not linger_file.stat.exists
      become: yes

    - name: "Set up subuid for {{ app_user }}"
      ansible.builtin.lineinfile:
        path: /etc/subuid
        line: "{{ app_user }}:100000:65536"
        create: yes
        mode: '0644'
      become: yes

    - name: "Set up subgid for {{ app_user }}"
      ansible.builtin.lineinfile:
        path: /etc/subgid
        line: "{{ app_user }}:100000:65536"
        create: yes
        mode: '0644'
      become: yes

    - name: Download rootless docker install script
      ansible.builtin.get_url:
        url: https://get.docker.com/rootless
        dest: "/home/{{ app_user }}/get-docker-rootless.sh"
        mode: '0755'
      become: yes
      become_user: "{{ app_user }}"

    - name: Ensure user bin directory exists
      ansible.builtin.file:
        path: "/home/{{ app_user }}/bin"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'
      become: yes

    - name: Ensure /dev/net/tun exists for rootless networking
      ansible.builtin.stat:
        path: /dev/net/tun
      register: tun_device_check
      become: yes
      become_user: root # Check as root because app_user might not have permissions to read /dev/net
    
    - name: Fail if /dev/net/tun is missing
      ansible.builtin.fail:
        msg: |
          The /dev/net/tun device is missing. This is required for rootless Docker networking (slirp4netns).
          Please ensure the 'tun' kernel module is loaded on your host system (e.g., 'modprobe tun')
          or contact your hosting provider to enable it.
      when: not tun_device_check.stat.exists

    - name: Check if AppArmor restricts unprivileged user namespaces
      ansible.builtin.command: sysctl -n kernel.apparmor_restrict_unprivileged_userns
      register: apparmor_restrict_userns
      failed_when: false
      changed_when: false
      become: yes

    - name: Create AppArmor profile for rootlesskit
      ansible.builtin.copy:
        dest: "/etc/apparmor.d/home.{{ app_user }}.bin.rootlesskit"
        content: |
          # Profile generated by Ansible for Rootless Docker
          abi <abi/4.0>,
          include <tunables/global>

          /home/{{ app_user }}/bin/rootlesskit flags=(unconfined) {
            userns,
            include if exists <local/home.{{ app_user }}.bin.rootlesskit>
          }
        mode: '0644'
      become: yes
      when: apparmor_restrict_userns.stdout | default('0') | trim == '1'
      notify: restart apparmor

    - name: Ensure AppArmor is reloaded immediately if profile changed
      ansible.builtin.service:
        name: apparmor
        state: reloaded
      become: yes
      when: apparmor_restrict_userns.stdout | default('0') | trim == '1'

    - name: Ensure rootless Docker binaries are installed by running the script
      ansible.builtin.command:
        cmd: "/home/{{ app_user }}/get-docker-rootless.sh --force"
      become: yes
      become_user: "{{ app_user }}"
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ app_user_uid.stdout }}"
        DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ app_user_uid.stdout }}/bus"

    - name: Create docker.service file for rootless Docker
      ansible.builtin.copy:
        dest: "/home/{{ app_user }}/.config/systemd/user/docker.service"
        content: |
          [Unit]
          Description=Docker Application Container Engine (Rootless)
          Documentation=https://docs.docker.com/go/rootless/
          After=network-online.target
          Wants=network-online.target

          [Service]
          Environment=PATH=/home/{{ app_user }}/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
          ExecStart=/home/{{ app_user }}/bin/dockerd-rootless.sh
          ExecReload=/bin/kill -s HUP $MAINPID
          TimeoutSec=0
          RestartSec=2
          Restart=always
          StartLimitBurst=3
          StartLimitInterval=60s
          LimitNOFILE=infinity
          LimitNPROC=infinity
          LimitCORE=infinity
          TasksMax=infinity
          Delegate=yes
          Type=simple
          KillMode=mixed

          [Install]
          WantedBy=default.target
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0644'
      become: yes
      become_user: "{{ app_user }}"

    - name: Add Docker bin to PATH for {{ app_user }}
      ansible.builtin.lineinfile:
        path: "/home/{{ app_user }}/.bashrc"
        line: "export PATH=/home/{{ app_user }}/bin:$PATH"
        create: yes
      become: yes
      become_user: "{{ app_user }}"

    - name: Add DOCKER_HOST to environment for {{ app_user }}
      ansible.builtin.lineinfile:
        path: "/home/{{ app_user }}/.bashrc"
        line: "export DOCKER_HOST=unix:///run/user/{{ app_user_uid.stdout }}/docker.sock"
        create: yes
      become: yes
      become_user: "{{ app_user }}"

- name: Reload systemd user daemon
  ansible.builtin.command:
    cmd: "systemctl --user daemon-reload"
  become: yes
  become_user: "{{ app_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ app_user_uid.stdout }}"
    DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ app_user_uid.stdout }}/bus"
  changed_when: true

- name: Start and enable rootless docker service for app_user
  ansible.builtin.command:
    cmd: "systemctl --user enable --now docker.service"
  become: yes
  become_user: "{{ app_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ app_user_uid.stdout }}"
    DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ app_user_uid.stdout }}/bus"
  changed_when: true

- name: Check for Docker socket
  ansible.builtin.stat:
    path: "/run/user/{{ app_user_uid.stdout }}/docker.sock"
  register: docker_socket_file
  become: yes
  become_user: "{{ app_user }}"
  retries: 3
  delay: 5
  until: docker_socket_file.stat.exists

- name: Fail if Docker socket does not exist
  ansible.builtin.fail:
    msg: "The Docker socket at /run/user/{{ app_user_uid.stdout }}/docker.sock was not found. The rootless Docker daemon may have failed to start."
  when: not docker_socket_file.stat.exists