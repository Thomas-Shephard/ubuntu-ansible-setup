---
# tasks file for rootless_docker setup for app_user
- name: Get app_user uid
  ansible.builtin.command:
    cmd: "id -u {{ app_user }}"
  register: app_user_uid
  changed_when: false

- name: Check if rootless Docker is already installed
  ansible.builtin.stat:
    path: "/home/{{ app_user }}/.config/systemd/user/docker.service"
  register: docker_service_file
  become: yes
  become_user: "{{ app_user }}"

- name: Install and configure rootless Docker
  when: not docker_service_file.stat.exists
  block:
    - name: Check if linger file exists for app_user
      ansible.builtin.stat:
        path: "/var/lib/systemd/linger/{{ app_user }}"
      register: linger_file
      become: yes

    - name: Enable lingering for app_user
      ansible.builtin.command:
        cmd: "loginctl enable-linger {{ app_user }}"
      when: not linger_file.stat.exists
      become: yes

    - name: "Set up subuid for {{ app_user }}"
      ansible.builtin.lineinfile:
        path: /etc/subuid
        line: "{{ app_user }}:100000:65536"
        create: yes
        mode: '0644'
      become: yes

    - name: "Set up subgid for {{ app_user }}"
      ansible.builtin.lineinfile:
        path: /etc/subgid
        line: "{{ app_user }}:100000:65536"
        create: yes
        mode: '0644'
      become: yes

    - name: Check if apparmor is installed
      ansible.builtin.command: dpkg -s apparmor
      register: apparmor_check
      changed_when: false
      failed_when: apparmor_check.rc != 0 and "package 'apparmor' is not installed" not in apparmor_check.stderr

    - name: Download rootless docker install script
      ansible.builtin.get_url:
        url: https://get.docker.com/rootless
        dest: "/home/{{ app_user }}/get-docker-rootless.sh"
        mode: '0755'
      become: yes
      become_user: "{{ app_user }}"

    - name: Temporarily disable AppArmor unprivileged userns restriction
      ansible.builtin.sysctl:
        name: kernel.apparmor_restrict_unprivileged_userns
        value: '0'
        state: present
      become: yes
      when: apparmor_check.rc == 0

    - name: Install rootless docker
      ansible.builtin.command:
        cmd: "/home/{{ app_user }}/get-docker-rootless.sh"
      become: yes
      become_user: "{{ app_user }}"
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ app_user_uid.stdout }}"
      notify: restore apparmor restriction

    - name: Add Docker bin to PATH for {{ app_user }}
      ansible.builtin.lineinfile:
        path: "/home/{{ app_user }}/.bashrc"
        line: "export PATH=/home/{{ app_user }}/bin:$PATH"
        create: yes
      become: yes
      become_user: "{{ app_user }}"

    - name: Add DOCKER_HOST to environment for {{ app_user }}
      ansible.builtin.lineinfile:
        path: "/home/{{ app_user }}/.bashrc"
        line: "export DOCKER_HOST=unix:///run/user/{{ app_user_uid.stdout }}/docker.sock"
        create: yes
      become: yes
      become_user: "{{ app_user }}"

- name: Reload systemd user daemon
  ansible.builtin.command:
    cmd: "systemctl --user daemon-reload"
  become: yes
  become_user: "{{ app_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ app_user_uid.stdout }}"
  changed_when: true

- name: Start and enable rootless docker service for app_user
  ansible.builtin.command:
    cmd: "systemctl --user enable --now docker.service"
  become: yes
  become_user: "{{ app_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ app_user_uid.stdout }}"
  changed_when: true

- name: Check for Docker socket
  ansible.builtin.stat:
    path: "/run/user/{{ app_user_uid.stdout }}/docker.sock"
  register: docker_socket_file
  become: yes
  become_user: "{{ app_user }}"
  retries: 3
  delay: 5
  until: docker_socket_file.stat.exists

- name: Fail if Docker socket does not exist
  ansible.builtin.fail:
    msg: "The Docker socket at /run/user/{{ app_user_uid.stdout }}/docker.sock was not found. The rootless Docker daemon may have failed to start."
  when: not docker_socket_file.stat.exists