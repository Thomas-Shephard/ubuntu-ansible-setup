---
- name: Check for docker-compose.yml
  ansible.builtin.stat:
    path: "/home/{{ app_user }}/app/docker-compose.yml"
  register: docker_compose_file
  become: yes
  become_user: "{{ app_user }}"

- name: Fail if docker-compose.yml not found
  ansible.builtin.fail:
    msg: "docker-compose.yml not found in the repository"
  when: not docker_compose_file.stat.exists

- name: Create systemd user directory
  ansible.builtin.file:
    path: "/home/{{ app_user }}/.config/systemd/user"
    state: directory
    mode: '0755'
  become: yes
  become_user: "{{ app_user }}"

- name: Install app systemd service
  ansible.builtin.template:
    src: app.service.j2
    dest: "/home/{{ app_user }}/.config/systemd/user/app.service"
    mode: '0644'
  become: yes
  become_user: "{{ app_user }}"
  notify: restart app service

- name: Enable and start app service
  ansible.builtin.systemd:
    name: app.service
    scope: user
    enabled: yes
    state: started
    daemon_reload: yes
  become: yes
  become_user: "{{ app_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ app_user_uid.stdout }}"

- name: Monitor Docker Compose service
  ansible.builtin.debug:
    msg: |
      Docker Compose application is managed by systemd.
      Initial build/pull may take a long time.
      To view status: `systemctl --user status app`
      To view live logs: `journalctl --user -u app -f`

- name: Verify application is responding (Health Check)
  ansible.builtin.uri:
    url: "http://localhost:{{ app_port }}"
    status_code: [200, 301, 302, 307, 308, 401, 403, 404]
    return_content: no
  register: app_health_check
  until: app_health_check.status != -1
  retries: 80 # 20 minutes wait
  delay: 15
  become: yes
  become_user: "{{ app_user }}"
  failed_when: app_health_check.status == -1
  ignore_errors: yes

- name: Prune unused Docker objects
  ansible.builtin.command:
    cmd: "/home/{{ app_user }}/bin/docker system prune -f"
  become: yes
  become_user: "{{ app_user }}"
  environment:
    DOCKER_HOST: "unix:///run/user/{{ app_user_uid.stdout }}/docker.sock"