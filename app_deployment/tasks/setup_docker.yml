---
- name: Check for docker-compose.yml
  ansible.builtin.stat:
    path: "/home/{{ app_user }}/app/docker-compose.yml"
  register: docker_compose_file
  become: yes
  become_user: "{{ app_user }}"

- name: Fail if docker-compose.yml not found
  ansible.builtin.fail:
    msg: "docker-compose.yml not found in the repository"
  when: not docker_compose_file.stat.exists

- name: Start application with Docker Compose (Background)
  ansible.builtin.shell:
    cmd: "/home/{{ app_user }}/bin/docker compose up --build --wait > /home/{{ app_user }}/app/deploy.log 2>&1"
    chdir: "/home/{{ app_user }}/app"
  become: yes
  become_user: "{{ app_user }}"
  environment: "{{
    {'DOCKER_HOST': 'unix:///run/user/' + app_user_uid.stdout + '/docker.sock', 'PATH': '/home/' + app_user + '/bin:' + ansible_env.PATH}
    | combine(found_ports | default({}))
    | combine(user_env_inputs_processed | default('{}') | from_yaml)
    }}"
  async: 1800 # 30 minutes timeout
  poll: 0
  register: docker_deploy

- name: "Manual Log Monitoring Instruction"
  ansible.builtin.debug:
    msg:
      - "Docker deployment started in background (Job ID: {{ docker_deploy.ansible_job_id }})."
      - "To view the live build logs, SSH onto the remote machine and run:"
      - "sudo -u {{ app_user }} tail -f /home/{{ app_user }}/app/deploy.log"

- name: Wait for Docker deployment to complete
  ansible.builtin.async_status:
    jid: "{{ docker_deploy.ansible_job_id }}"
  register: job_result
  until: job_result.finished
  retries: 180 # 180 * 10s = 30 minutes
  delay: 10
  become: yes
  become_user: "{{ app_user }}"
