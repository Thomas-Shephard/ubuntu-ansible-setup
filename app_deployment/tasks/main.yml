---
# tasks file for app_deployment
- name: "Fail if app_repo is not set"
  ansible.builtin.fail:
    msg: "The 'app_repo' variable is set to the default placeholder 'your_app_repo.git'. Please provide a valid Git repository URL in app_deployment/vars/main.yml."
  when: app_repo == 'your_app_repo.git'
  run_once: true

- name: Ensure git is installed
  ansible.builtin.apt:
    name: git
    state: present
    update_cache: yes

- name: Check if the git repository is valid and accessible
  ansible.builtin.command:
    cmd: "git ls-remote {{ app_repo }}"
  register: git_check
  changed_when: false
  failed_when: false # We handle the failure manually
  run_once: true

- name: Fail if git repository is not accessible
  ansible.builtin.fail:
    msg: "The git repository '{{ app_repo }}' is not accessible. Please check the URL and access rights. Error: {{ git_check.stderr }}"
  when: git_check.rc != 0
  run_once: true

- name: Validate that APP_PORT is defined in app_ports
  ansible.builtin.fail:
    msg: "The 'app_ports' list in app_deployment/vars/main.yml must contain 'APP_PORT' for Nginx configuration."
  when: "'APP_PORT' not in app_ports"

- name: Set app_user fact
  ansible.builtin.set_fact:
    app_user: "{{ (app_repo | basename | regex_replace('.git$', ''))[:32] }}"

- name: Create a new system user for the application
  ansible.builtin.user:
    name: "{{ app_user }}"
    shell: /usr/sbin/nologin
    system: yes
    create_home: yes

- name: Ensure remote_tmp directory exists for app_user
  ansible.builtin.file:
    path: "/home/{{ app_user }}/.ansible/tmp"
    state: directory
    mode: '0755'
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
  become: yes

- name: Set up rootless docker for app user
  ansible.builtin.include_tasks: rootless_docker.yml

- name: Find available ports for the application
  ansible.builtin.shell: |
    comm -23 <(seq 8080 8180 | sort) <(ss -Htan | awk '{print $4}' | awk -F':' '{print $NF}' | sort -u) | head -n {{ app_ports | length }}
  args:
    executable: /bin/bash
  register: next_available_ports
  changed_when: false

- name: Create a dictionary of found ports
  ansible.builtin.set_fact:
    found_ports: "{{ dict(app_ports | zip(next_available_ports.stdout_lines)) }}"

- name: Set app_port fact for Nginx
  ansible.builtin.set_fact:
    app_port: "{{ found_ports.APP_PORT }}"

- name: Display assigned ports
  ansible.builtin.debug:
    msg: "{{ my_message.split('\n') }}"
  vars:
    my_message: |
      Application ports have been assigned as follows:
      {% for port_name, host_port in found_ports.items() %}
      Service {{ port_name | replace('_PORT', '') | lower | capitalize }} ({{ port_name }}) is accessible via VPN at {{ ansible_host }}:{{ host_port }}
      {% endfor %}

- name: Read apps.json
  ansible.builtin.slurp:
    src: /var/www/status/apps.json
  register: apps_json_content

- name: Update apps.json
  ansible.builtin.copy:
    content: "{{ apps_json_content.content | b64decode | from_json | combine({app_user: found_ports}) | to_json }}"
    dest: /var/www/status/apps.json
  when: apps_json_content.content is defined

- name: Create app directory
  ansible.builtin.file:
    path: "/home/{{ app_user }}/app"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: '0755'

- name: Clone the application repository
  ansible.builtin.git:
    repo: "{{ app_repo }}"
    dest: "/home/{{ app_user }}/app"
    accept_hostkey: yes
  become: yes
  become_user: "{{ app_user }}"

- name: Setup environment variables
  ansible.builtin.include_tasks: setup_env.yml

- name: Setup and run Docker
  ansible.builtin.include_tasks: setup_docker.yml

- name: Setup Nginx and SSL
  ansible.builtin.include_tasks: setup_nginx.yml