from flask import Flask, render_template, request
import json
import sys
import os

# Ensure Flask knows where to look for templates
template_dir = os.path.abspath('/var/www/status/templates')
app = Flask(__name__, template_folder=template_dir)

@app.route('/')
def status():
    try:
        with open('/var/www/status/apps.json', 'r') as f:
            apps = json.load(f)
    except (IOError, ValueError) as e:
        print(f"Error loading apps.json: {e}", file=sys.stderr)
        apps = {}

    # Debug output to journal
    print(f"Loaded apps: {apps}", file=sys.stderr)

    # Get hostname safely
    try:
        hostname = request.host.split(':')[0]
    except Exception:
        hostname = 'localhost'

    return render_template('status.html', apps=apps, ansible_host=hostname)

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5001, debug=True)
