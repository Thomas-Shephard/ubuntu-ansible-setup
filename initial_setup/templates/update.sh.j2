#!/bin/bash
REPO_NAME=$1
APP_USER=$2
BRANCH=${3:-master}

# Ensure APP_USER is provided
if [ -z "$APP_USER" ]; then
    echo "Error: APP_USER argument missing"
    exit 1
fi

if [ "$APP_USER" = "root" ]; then
    echo "Error: Cannot update for root user"
    exit 1
fi

# Sanitize APP_USER input to prevent directory traversal or injection
if [[ ! "$APP_USER" =~ ^[a-z0-9_-]+$ ]]; then
    echo "Error: Invalid APP_USER format. Only alphanumeric characters, hyphens, and underscores are allowed."
    exit 1
fi

APP_DIR="/home/$APP_USER/app"
ENV_EXAMPLE_PATH="$APP_DIR/.env.example"
ENV_PATH="$APP_DIR/.env"

if [ -d "$APP_DIR" ]; then
  echo "Starting update for $REPO_NAME (User: $APP_USER, Branch: $BRANCH)..."

  # 1. Pull latest changes as the app user
  # We use sudo to ensure file permissions remain correct
  sudo -u "$APP_USER" git -C "$APP_DIR" pull origin "$BRANCH"

  # 2. Check for new environment variables
  if [ -f "$ENV_EXAMPLE_PATH" ]; then
    # Use sudo cat to read files that might be 0600 owned by app_user
    ENV_EXAMPLE_KEYS=$(sudo -u "$APP_USER" cat "$ENV_EXAMPLE_PATH" | grep -E '^[[:space:]]*([A-Za-z0-9_.-]+)=' | sed -E 's/^[[:space:]]*([A-Za-z0-9_.-]+)=.*/\1/' | sort)

    if sudo -u "$APP_USER" test -f "$ENV_PATH"; then
      EXISTING_ENV_KEYS=$(sudo -u "$APP_USER" cat "$ENV_PATH" | grep -E '^[[:space:]]*([A-Za-z0-9_.-]+)=' | sed -E 's/^[[:space:]]*([A-Za-z0-9_.-]+)=.*/\1/' | sort)
    else
      EXISTING_ENV_KEYS=""
    fi

    # Find new keys in .env.example not present in .env
    NEW_KEYS=$(comm -13 <(echo "$EXISTING_ENV_KEYS") <(echo "$ENV_EXAMPLE_KEYS"))

    if [ -n "$NEW_KEYS" ]; then
      echo "ERROR: New environment variables detected in .env.example that are not in .env:" >&2
      echo "$NEW_KEYS" >&2
      echo "Automatic deployment aborted. Please run Ansible or update .env manually." >&2
      exit 1
    fi
  fi

  # 3. Determine UID for Rootless Docker Socket
  APP_UID=$(id -u "$APP_USER")

  # 4. Run Docker Compose
  # We must export DOCKER_HOST and XDG_RUNTIME_DIR so the client finds the rootless daemon
  echo "Rebuilding and restarting containers..."
  sudo -u "$APP_USER" \
       DOCKER_HOST="unix:///run/user/$APP_UID/docker.sock" \
       XDG_RUNTIME_DIR="/run/user/$APP_UID" \
       /home/"$APP_USER"/bin/docker compose -f "$APP_DIR/docker-compose.yml" up -d --build

  # 5. Prune dangling images to save space
  echo "Pruning dangling images..."
  sudo -u "$APP_USER" \
       DOCKER_HOST="unix:///run/user/$APP_UID/docker.sock" \
       XDG_RUNTIME_DIR="/run/user/$APP_UID" \
       /home/"$APP_USER"/bin/docker image prune -f

else
  echo "Error: App directory $APP_DIR does not exist."
  exit 1
fi